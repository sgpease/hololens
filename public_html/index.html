<!DOCTYPE html>
<html>
<head>
	<meta charset=utf-8>
	<title>S2S Business Overview</title>
	<!--Body background image is not supported in HTML5 using CSS instead -->
	<!-- Bootstrap -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<link href="css/additionalStyle.css" rel="stylesheet">
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">
	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
</head>
<body>
	<script src="js/s2s_mqtt.js"></script>
	<script src="js/mqttws/mqttws31.js"></script>
	<div class="introContainer">
		<h1>EIIS Lab Tracking System </h1>
		<p class="introText"> Target requested (<span id="printx"></span>m, <span id="printy"></span>m)</p>
		<p id="printlocation"></p>
	</div>
	<div class="row">
		<div class = "col-lg-10" padding="100" >

            <svg id="svgBox" width="500" height="300" preserveAspectRatio="xMidYMid meet"  viewBox="0 0 500 300" fill: none; >
               
                     <rect id="canvas" x="0" y="0" width="500" height="300" border-width=5 fill: none;/> 
               
            </svg>    
        </div>
	</div>
	<div class="row">
		</div>
	<script>
		document.getElementById("printx").innerHTML = 0;
		document.getElementById("printy").innerHTML = 0;

		client = new Messaging.Client("localhost", Number("8000"), "clientId");
		client.onConnectionLost = onConnectionLost;
		client.onMessageArrived = onMessageArrived;
		client.connect({
			onSuccess: onConnect
		});

		function onConnectionLost(responseObject) {
			if (responseObject.errorCode !== 0)
				console.log("onConnectionLost:" + responseObject.errorMessage);
		};

		function onMessageArrived(message) {
			console.log("onMessageArrived:" + message.payloadString);
			try {
				var positionObject = JSON.parse(message.payloadString);
				if (positionObject.Description === "hololens") {
					moveLine(positionObject.x, positionObject.z);
				}
			} catch (e) {
  				//console.log(error);

			} finally {

			}
			//client.disconnect();
		};

		function onConnect() {
			// Once a connection has been made, make a subscription and send a message.
			console.log("onConnect");
			client.subscribe("hololens1/output/#");

		};

		function publishTarget(x,y,d) {
			// Once a connection has been made, make a subscription and send a message.
			client.subscribe("hololens1/input/");
   		 	outputmessage = new Messaging.Message("{\"x\":" + x.toFixed(2) + ", \"z\":" + y.toFixed(2) + ", \"d\":" + d.toFixed(2) + "}");
			outputmessage.destinationName = "hololens1/input/";
			client.send(outputmessage);

		};

		var svg = document.getElementById("svgBox");
		var rect = svg.getElementById("canvas");
		var pt = svg.createSVGPoint();
		var roomOriginX = 0;
		var roomOriginY = 0;
		// MARK ORIGIN at 0,0
		createDot(roomOriginX+2,roomOriginY+3, 3,'red');
		svg.addEventListener("mousedown", alert_click, false);

		function moveLine(x, y) {
			createDot((roomOriginX + (x * 10)),(roomOriginY + (y * 10)), 3, 'black');
		};

		function alert_click(evt) {
    		var cursorpt = cursorPoint(evt, canvas);
   		 	//console.log("(" + cursorpt.x + ", " + cursorpt.y + ")");
   		 	//alert("(" + cursorpt.x + ", " + cursorpt.y + ")");
   		 	dx = cursorpt.x-roomOriginX;
   		 	dy = cursorpt.y-roomOriginY;

   		 	distance = Math.sqrt((dx*dx)+(dy*dy));

   		 	// PRINT AND SEND CLICK LOCATION POINTS
			document.getElementById("printx").innerHTML = cursorpt.x.toFixed(2);
			document.getElementById("printy").innerHTML = cursorpt.y.toFixed(2);
			publishTarget(cursorpt.x,cursorpt.y,distance)
		};

    	// OUTPUT CLICK LOCATION POINTS
		function cursorPoint(evt, element) {
   			pt.x = evt.clientX; 
    		pt.y = evt.clientY;
    		if (element === null)
        		return pt.matrixTransform(svg.getScreenCTM().inverse());
    		else
        		return pt.matrixTransform(element.getScreenCTM().inverse());
		};


    	// RENDER DOTS FOR LOCATION
		function createDot(x, y, rad, color) {
        	var circle= makeSVG('circle', {cx: x, cy: y, r:rad, fill: color});
        	document.getElementById('svgBox').appendChild(circle);
		};

        function makeSVG(tag, attrs) {
            var el= document.createElementNS('http://www.w3.org/2000/svg', tag);
            for (var k in attrs)
                el.setAttribute(k, attrs[k]);
            return el;
        }
	</script>




</body>

</html>
